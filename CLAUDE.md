# libsignal - Claude Code Configuration

## Important Rules

**ALWAYS use Makefile commands.** Never call scripts directly via `fvm dart run scripts/...`. The Makefile is the single entry point for all operations.

```bash
# Correct - pass arguments via ARGS variable
make build ARGS="macos"
make build ARGS="macos --arch arm64"
make test
make analyze ARGS="--fatal-infos"

# Wrong - never do this
fvm dart run scripts/build.dart macos
make build macos --arch arm64  # make interprets --arch as its own flag!
```

## Quick Reference

| Task | Command |
|------|---------|
| Initial setup | `make setup` |
| Show all commands | `make help` |
| Build native library | `make build ARGS="<platform>"` |
| Run tests | `make test` |
| Run analysis | `make analyze` |
| Strict analysis | `make analyze ARGS="--fatal-infos"` |
| Format code | `make format` |
| Regenerate FFI bindings | `make regen` |
| Check for updates | `make check` |
| Get dependencies | `make get` |
| Show libsignal version | `make version` |

## Project Overview

Dart FFI bindings for libsignal - Signal Protocol implementation for end-to-end encryption.

### Key Features
- Signal Protocol (Double Ratchet, X3DH)
- Sealed Sender (anonymous messaging)
- Group Messaging (SenderKey)
- Pre-built native libraries for all platforms
- Automated security updates via GitHub Actions

### Upstream Repository
- **libsignal**: https://github.com/signalapp/libsignal

## Project Structure

```
libsignal/
├── lib/                            # Dart library code
│   └── src/
│       ├── bindings/
│       │   └── libsignal_bindings.dart  # Auto-generated FFI bindings
│       ├── keys.dart               # Key types (PrivateKey, PublicKey, etc.)
│       ├── protocol.dart           # Signal Protocol (sessions, encryption)
│       ├── stores.dart             # Store abstractions
│       ├── sealed_sender.dart      # Sealed sender
│       └── groups.dart             # Group messaging
├── bin/                            # Pre-built server/CLI libraries
│   ├── linux/libsignal_ffi.so
│   ├── macos/libsignal_ffi.dylib
│   └── windows/signal_ffi.dll
├── android/src/main/jniLibs/       # Android libraries
├── ios/Libraries/                  # iOS libraries
├── macos/Libraries/                # macOS Flutter library
├── headers/                        # C headers (generated by cbindgen)
│   └── signal_ffi.h
├── scripts/                        # Build scripts (use via Makefile!)
├── test/                           # Tests
├── Makefile                        # Entry point for all commands
├── LIBSIGNAL_VERSION               # Current libsignal version
└── .github/workflows/              # CI/CD workflows
```

## Build System

This project uses **Rust/Cargo** to build libsignal (unlike liboqs which uses CMake).

### Rust Targets

| Platform | Rust Target |
|----------|-------------|
| Linux x86_64 | `x86_64-unknown-linux-gnu` |
| Linux arm64 | `aarch64-unknown-linux-gnu` |
| macOS arm64 | `aarch64-apple-darwin` |
| macOS x86_64 | `x86_64-apple-darwin` |
| iOS device | `aarch64-apple-ios` |
| iOS simulator arm64 | `aarch64-apple-ios-sim` |
| iOS simulator x86_64 | `x86_64-apple-ios` |
| Android arm64 | `aarch64-linux-android` |
| Android arm | `armv7-linux-androideabi` |
| Android x86_64 | `x86_64-linux-android` |
| Windows | `x86_64-pc-windows-msvc` |

### Build Requirements

- **Rust toolchain** (rustup, cargo)
- **cbindgen** (for C header generation)
- **Android NDK** (for Android builds)
- **Xcode** (for iOS/macOS builds)

## Supported Platforms

| Platform | Architecture | Library | Location |
|----------|--------------|---------|----------|
| Linux | x86_64, arm64 | `libsignal_ffi.so` | `bin/linux/` |
| macOS | Universal | `libsignal_ffi.dylib` | `bin/macos/` |
| Windows | x86_64 | `signal_ffi.dll` | `bin/windows/` |
| iOS | device, simulator | `libsignal_ffi.dylib` | `ios/Libraries/` |
| Android | arm64-v8a, armeabi-v7a, x86_64 | `libsignal_ffi.so` | `android/src/main/jniLibs/` |

## FVM (Flutter Version Management)

This project uses FVM for consistent Flutter/Dart versions.

**Version:** Flutter 3.38.4 (Dart SDK 3.10.0)

FVM is automatically installed by `make setup`.
